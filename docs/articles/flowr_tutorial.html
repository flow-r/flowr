<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>flowr • flowr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="flowr">
<meta property="og:description" content="flowr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flowr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.11</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flowr_install.html">flowr</a>
    </li>
    <li>
      <a href="../articles/flowr_overview.html">flowr</a>
    </li>
    <li>
      <a href="../articles/flowr_tutorial.html">flowr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/flow-r/flowr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="flowr_tutorial_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>flowr</h1>
            <h3 class="subtitle">Streamlining Workflows</h3>
                        <h4 class="author">Sahil Seth</h4>
            
            <h4 class="date">2021-03-02</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/flow-r/flowr/blob/master/vignettes/flowr_tutorial.Rmd"><code>vignettes/flowr_tutorial.Rmd</code></a></small>
      <div class="hidden name"><code>flowr_tutorial.Rmd</code></div>

    </div>

    
    
<div id="creating-input-files" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-input-files" class="anchor"></a>Creating input file(s)</h1>
<p>Let us use the same example described in the overview section. We start by getting a set of commands we would like to run.</p>
<pre><code>## wait for a few seconds…
sleep 5
sleep 5

## create two small files
cat $RANDOM &gt; tmp1
cat $RANDOM &gt; tmp2

## merge the two files
cat tmp1 tmp2 &gt; tmp

## check the size of the resulting file
du -sh tmp</code></pre>
<p><strong>Wrap these commands into R</strong></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sleep</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'sleep 5'</span>, <span class="st">'sleep 5'</span><span class="op">)</span>

<span class="va">tmp</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'cat $RANDOM &gt; tmp1'</span>, 
            <span class="st">'cat $RANDOM &gt; tmp2'</span><span class="op">)</span>
            
<span class="va">merge</span><span class="op">=</span><span class="st">'cat tmp1 tmp2 &gt; tmp'</span>
            
<span class="va">size</span><span class="op">=</span><span class="st">'du -sh tmp'</span></code></pre></div>
<p>Next, we would create a table using the above commands:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## create a table of all commands</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/flow-r/flowr">flowr</a></span><span class="op">)</span>
<span class="va">lst</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> sleep<span class="op">=</span><span class="va">sleep</span>, 
           create_tmp<span class="op">=</span><span class="va">tmp</span>, 
           merge<span class="op">=</span><span class="va">merge</span>,
           size<span class="op">=</span><span class="va">size</span><span class="op">)</span>

<span class="va">flowmat</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowmat.html">to_flowmat</a></span><span class="op">(</span><span class="va">lst</span>, <span class="st">"samp1"</span><span class="op">)</span>
<span class="fu">kable</span><span class="op">(</span><span class="va">flowmat</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">samplename</th>
<th align="left">jobname</th>
<th align="left">cmd</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">samp1</td>
<td align="left">sleep</td>
<td align="left">sleep 5</td>
</tr>
<tr class="even">
<td align="left">samp1</td>
<td align="left">sleep</td>
<td align="left">sleep 5</td>
</tr>
<tr class="odd">
<td align="left">samp1</td>
<td align="left">create_tmp</td>
<td align="left">cat $RANDOM &gt; tmp1</td>
</tr>
<tr class="even">
<td align="left">samp1</td>
<td align="left">create_tmp</td>
<td align="left">cat $RANDOM &gt; tmp2</td>
</tr>
<tr class="odd">
<td align="left">samp1</td>
<td align="left">merge</td>
<td align="left">cat tmp1 tmp2 &gt; tmp</td>
</tr>
<tr class="even">
<td align="left">samp1</td>
<td align="left">size</td>
<td align="left">du -sh tmp</td>
</tr>
</tbody>
</table>
<div id="creating-flow-definition" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-flow-definition" class="anchor"></a>Creating Flow Definition</h2>
<p>We have a few steps in a pipeline; we would use a flow definition to describe their flow. Flowr enables us to quickly create a skeleton flow definition using a flowmat, which we can then alter to suit our needs. A handy function <code>to_flowdef</code>, accepts a <code>flowmat</code> and creates a flow definition.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## create a skeleton flow definition</span>
<span class="va">def</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowdef.html">to_flowdef</a></span><span class="op">(</span><span class="va">flowmat</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/message.html">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="../reference/plot_flow.html">plot_flow</a></span><span class="op">(</span><span class="va">def</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="flowr_tutorial_files/figure-html/plot_skeleton_def-1.png" width="700"></p>
<div class="alert alert-info" role="alert">
<p>The default skeleton takes a very conservative approach, creating all submissions as <strong>serial</strong> and all dependencies as <strong>gather</strong>. This ensures robustness, compromising efficiency. So customize this to make it super efficient.</p>
</div>
<p>We can make a few changes to make this pipeline a little more efficient. Briefly, we would run a few steps in a <strong>scatter</strong> fashion (in parallel).</p>
<p>A few points to note:</p>
<ul>
<li>Initial steps have no dependency, so their <strong>previous_jobs</strong> and <strong>dependency_type</strong> is <strong>none</strong>.</li>
<li>Steps with multiple commands, which can be run in parallel are submitted as <strong>scatter</strong>.</li>
<li>Steps with single commands are submitted as <strong>serial</strong>.</li>
<li>Say two consecutive steps run on small pieces of data, we have a <strong>serial</strong> <strong>one to one</strong> relationship. Example, both <strong>sleep</strong> and <strong>create_tmp</strong> are submitted as <strong>scatter</strong> and <strong>create_tmp</strong> has a dependency_type <strong>serial</strong>.</li>
<li>Finally if a step needs all the small pieces from a previous step, we use a <strong>gather</strong> type dependency.</li>
</ul>
<!-- multiple *sleep* commands would run as `scatter`/parallel, with `none` as the dependency.
- For each *sleep*, *create_tmp* creates a tmp file as `scatter`, using a `serial` type dependency. One `create_tmp` for one `sleep` (one-to-one relationship).
- Then all tmp files are *merged*. Intuitively, since this is a single step, we run it as `serial` and as all tmp files are required, we use a `gather` type dependency.
- Lastly, we need to check the *size* of the resulting merged file.
Again, since this is a single step, we run is as `serial`. More so since the previous step also had a single command, we use a `serial` type dependency.--><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">##               sleep     create tmp   merge     size</span>
<span class="va">def</span><span class="op">$</span><span class="va">sub_type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"scatter"</span>, <span class="st">"scatter"</span>, <span class="st">"serial"</span>, <span class="st">"serial"</span><span class="op">)</span>
<span class="va">def</span><span class="op">$</span><span class="va">dep_type</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"serial"</span>, <span class="st">"gather"</span>, <span class="st">"serial"</span><span class="op">)</span>
<span class="fu">kable</span><span class="op">(</span><span class="va">def</span><span class="op">)</span></code></pre></div>
<table class="table">
<colgroup>
<col width="10%">
<col width="8%">
<col width="10%">
<col width="8%">
<col width="5%">
<col width="15%">
<col width="8%">
<col width="12%">
<col width="5%">
<col width="8%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">jobname</th>
<th align="left">sub_type</th>
<th align="left">prev_jobs</th>
<th align="left">dep_type</th>
<th align="left">queue</th>
<th align="left">memory_reserved</th>
<th align="left">walltime</th>
<th align="right">cpu_reserved</th>
<th align="left">nodes</th>
<th align="left">platform</th>
<th align="right">jobid</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sleep</td>
<td align="left">scatter</td>
<td align="left">none</td>
<td align="left">none</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">1</td>
<td align="left">torque</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">create_tmp</td>
<td align="left">scatter</td>
<td align="left">sleep</td>
<td align="left">serial</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">1</td>
<td align="left">torque</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">merge</td>
<td align="left">serial</td>
<td align="left">create_tmp</td>
<td align="left">gather</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">1</td>
<td align="left">torque</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">size</td>
<td align="left">serial</td>
<td align="left">merge</td>
<td align="left">serial</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">1</td>
<td align="left">torque</td>
<td align="right">4</td>
</tr>
</tbody>
</table>
<p><img src="flowr_tutorial_files/figure-html/plot_tweaked_def-1.png" width="700"></p>
<div class="alert alert-info" role="alert">
<p><strong>Tip</strong> Alternatively, one may write this to a file (<strong>write_sheet(def, “sleep_pipe.def”)</strong>), make changes in a text editor and read it again (<strong>as.flowdef(“sleep_pipe.def”)</strong>.</p>
</div>
</div>
<div id="create-flow-submit-to-cluster" class="section level2">
<h2 class="hasAnchor">
<a href="#create-flow-submit-to-cluster" class="anchor"></a>Create flow, submit to cluster</h2>
<p><strong>Next, we create a flow object:</strong></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fobj</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flow.html">to_flow</a></span><span class="op">(</span><span class="va">flowmat</span>, <span class="va">def</span>, flowname <span class="op">=</span> <span class="st">"sleep_pipe"</span><span class="op">)</span></code></pre></div>
<p><strong>Finally, we can submit this to the cluster:</strong></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_flow.html">plot_flow</a></span><span class="op">(</span><span class="va">fobj</span><span class="op">)</span>
<span class="fu"><a href="../reference/submit_flow.html">submit_flow</a></span><span class="op">(</span><span class="va">fobj</span><span class="op">)</span> <span class="co">## dry run</span>
<span class="va">fobj2</span> <span class="op">=</span> <span class="fu"><a href="../reference/submit_flow.html">submit_flow</a></span><span class="op">(</span><span class="va">fobj</span>, execute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="co">## submission to LSF cluster</span>

<span class="co">## after submission, we can use the following:</span>
<span class="fu"><a href="../reference/status.html">status</a></span><span class="op">(</span><span class="va">fobj2</span><span class="op">)</span> <span class="co">## check status</span>
<span class="fu"><a href="../reference/rerun.html">rerun</a></span><span class="op">(</span><span class="va">fobj2</span><span class="op">)</span>  <span class="co">## re-run from a intermediate step</span>
<span class="fu"><a href="../reference/kill.html">kill</a></span><span class="op">(</span><span class="va">fobj2</span><span class="op">)</span>   <span class="co">## kill it!</span></code></pre></div>
</div>
<div id="creating-modules" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-modules" class="anchor"></a>Creating modules</h2>
<p>We used a simple example where a single function was creating all the commands. This is easier, but a step (or module) is not re-usable in another pipeline. Thus we may write a module for each step, such that one may mix and match to create their own pipeline.</p>
<p><strong>NOTE:</strong> A module, always returns a flowmat. A module may have one or several steps. A module + flowdef, becomes a pipeline.</p>
<pre><code>## to follow this tutorial, you may download them:
url=https://raw.githubusercontent.com/sahilseth/flowr/master/inst/pipelines
cd ~/flowr/pipelines
wget $url/sleep_pipe.R ## A R script, with sleep_pipe(), which creates a flowmat
wget $url/sleep_pipe.def ## A tab-delimited flow definition file
wget $url/sleep_pipe.conf ## An *optional* tab-delim conf file, defining default params</code></pre>
<p>The <code>sleep_pipe</code> calls the three other functions (<strong>modules</strong>); fetches flowmat from each, then rbinds them, creating a larger flowmat. You may refer to the <a href="https://github.com/flow-r/flowr/blob/master/inst/pipelines/sleep_pipe.R">sleep_pipe.R</a> file for the source.</p>
</div>
</div>
<div id="execute-the-pipeline" class="section level1">
<h1 class="hasAnchor">
<a href="#execute-the-pipeline" class="anchor"></a>Execute the pipeline</h1>
<p><strong>Using run</strong></p>
<p>One may use <code>run</code> function to create the flowmat, fetch the flowdef and execute the pipeline in a single step. Here we would focus more on each of these steps in detail.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## 1. Single step submission:</span>
<span class="va">fobj</span> <span class="op">=</span> <span class="fu"><a href="../reference/run.html">run</a></span><span class="op">(</span><span class="st">"sleep_pipe"</span>, execute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>; 

<span class="co">## 2</span>
<span class="co">## change wd, so that we can source the files downloaded in the previous step</span>
<span class="fu"><a href="https://rdrr.io/r/base/getwd.html">setwd</a></span><span class="op">(</span><span class="st">"~/flowr/pipelines"</span><span class="op">)</span>

<span class="co">## 2a. optionally, load default parameters</span>
<span class="fu"><a href="../reference/flowopts.html">load_opts</a></span><span class="op">(</span><span class="st">"sleep_pipe.conf"</span><span class="op">)</span> 

<span class="co">## 2b. get sleep_pipe() function</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"sleep_pipe.R"</span><span class="op">)</span> 
<span class="co">## create a flowmat</span>
<span class="va">flowmat</span> <span class="op">=</span> <span class="fu">sleep_pipe</span><span class="op">(</span><span class="op">)</span>

<span class="co">## 2c. read a flow definition.</span>
<span class="va">flowdef</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowdef.html">as.flowdef</a></span><span class="op">(</span><span class="st">"sleep_pipe.def"</span><span class="op">)</span>

<span class="co">## 2d. create flow and submit to cluster</span>
<span class="va">fobj</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flow.html">to_flow</a></span><span class="op">(</span><span class="va">flowmat</span>, <span class="va">flowdef</span>, execute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
</div>
<div id="best-practices-for-writing-modulespipelines" class="section level1">
<h1 class="hasAnchor">
<a href="#best-practices-for-writing-modulespipelines" class="anchor"></a>Best practices for writing modules/pipelines</h1>
<p>These are some of the practices we follow in-house. We feel using these makes stitching custom pipelines using a set of modules quite easy. Consider this a check-list of a few ideas and a work in progress.</p>
<div id="a-note-on-module-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#a-note-on-module-functions" class="anchor"></a>A note on module functions</h2>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">picard_merge</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, 
                        <span class="va">samplename</span> <span class="op">=</span> <span class="va">opts_flow</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"samplename"</span><span class="op">)</span>,
                         <span class="va">mergedbam</span>,
                         <span class="va">java_exe</span> <span class="op">=</span> <span class="va">opts_flow</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"java_exe"</span><span class="op">)</span>,
                         <span class="va">java_mem</span> <span class="op">=</span> <span class="va">opts_flow</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"java_mem"</span><span class="op">)</span>,
                         <span class="va">java_tmp</span> <span class="op">=</span> <span class="va">opts_flow</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"java_tmp"</span><span class="op">)</span>,
                         <span class="va">picard_jar</span> <span class="op">=</span> <span class="va">opts_flow</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"picard_jar"</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="co">## Make sure all args have a value (not null)</span>
    <span class="co">## If a variable was not defined in a conf. file opts_flow$get, will return NULL</span>
    <span class="fu"><a href="../reference/check_args.html">check_args</a></span><span class="op">(</span><span class="op">)</span>  
  
  <span class="va">bam_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"INPUT="</span>, <span class="va">x</span>, sep <span class="op">=</span> <span class="st">""</span>, collapse <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>
  <span class="co">## create a named list of commands</span>
  <span class="va">cmds</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>merge <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span><span class="op">(</span><span class="st">"%s %s -Djava.io.tmpdir=%s -jar %s MergeSamFiles %s OUTPUT=%s ASSUME_SORTED=TRUE VALIDATION_STRINGENCY=LENIENT CREATE_INDEX=true USE_THREADING=true"</span>,<span class="va">java_exe</span>, <span class="va">java_mem</span>, <span class="va">java_tmp</span>, <span class="va">picard_jar</span>, <span class="va">bam_list</span>, <span class="va">mergedbam</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co">## Create a flowmat</span>
  <span class="va">flowmat</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowmat.html">to_flowmat</a></span><span class="op">(</span><span class="va">cmds</span>, <span class="va">samplename</span><span class="op">)</span>
  
  <span class="co">## return a list, flowmat AND outfiles</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>outfiles <span class="op">=</span> <span class="va">mergedbam</span>, flowmat <span class="op">=</span> <span class="va">flowmat</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>should accept minimum of <strong>two inputs</strong>,
<ul>
<li>
<strong>x</strong> (a input file etc, depends on the module) and</li>
<li>samplename (is used to append a column to the flowmat)</li>
</ul>
</li>
<li>should always return a list arguments:
<ul>
<li>
<strong>flowmat</strong> (required) : contains all the commands to run</li>
<li>
<strong>outfiles</strong> (recommended): could be used as an input to other tools</li>
</ul>
</li>
<li>can define all other default arguments such as paths to tools etc. in a separate conf (tab-delimited) file.</li>
</ol>
<ul>
<li>Then use <code>opts_flow$get("param")</code> to use their value.</li>
</ul>
<pre><code>## Example conf file:
cat my.conf
bwa_exe /apps/bwa/bin/bwa</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>should use <code><a href="../reference/check_args.html">check_args()</a></code> to make sure none of the default parameters are null.</li>
</ol>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## check_args(), checks ALL the arguments of the function, and throws a error. use ?check_args for more details.</span>
<span class="va">opts_flow</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"my_new_tool"</span><span class="op">)</span></code></pre></div>
<pre><code>## NULL</code></pre>
</div>
<div id="pipeline-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#pipeline-structure" class="anchor"></a>Pipeline structure</h2>
<p>For example we have a pipeline consisting of alignment using bwa (aln1, aln2, sampe), fix rg tags using picard and merging the files. We would create three files:</p>
<pre><code>fastq_bam_bwa.R      ## A R script, with fastq_bam_bwa(), which creates a flowmat
fastq_bam_bwa.conf   ## An *optional* tab-delim conf file, defining default params
fastq_bam_bwa.def    ## A tab-delimited flow definition file</code></pre>
<p>Notice how all files have the same basename; this is essential for the <strong>run</strong> function to find all these files.</p>
<ol style="list-style-type: decimal">
<li>all three files should have the same basename</li>
</ol>
<p><strong>Reason for using the same basename</strong>:</p>
<ul>
<li>When we call <code><a href="../reference/run.html">run("fastq_bam_bwa", ....)</a></code> it tries to look for a .R file inside flowr’s package, <code>~/flowr/pipelines</code> OR your current wd. If there are multiple matches, later is chosen.</li>
<li>Then, it finds and load default parameters from <code>fastq_bam_bwa.conf</code> (if available).</li>
<li>Further, it calls the function <code>fastq_bam_bwa</code>, then stitches a flow using <code>fastq_bam_bwa.def</code> as the flow definition.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>can have multiple flowdefs like fastq_bam_bwa_lsf.def, fastq_bam_bwa_lsf.def etc, where <basename>.def is used by default. But other are available for users to switch platforms quickly.</basename>
</li>
</ol>
<p><strong>Feature</strong>:</p>
<ul>
<li>A user can supply a custom flow definition</li>
</ul>
<pre><code>run('fastq_bam_bwa', def = 'path/myflowdef.def'....)</code></pre>
<ul>
<li>Starting flowr version <em>0.9.8.9011</em>, run also accepts a custom conf file in addition to a flowdef file. Conf contains all the default parameters like absolute paths to tools, paths to genomes, indexes etc.</li>
</ul>
<pre><code><a href="../reference/run.html">run('fastq_bam_bwa', def = 'path/myflowdef.def', conf='path/myconf.conf',....)</a></code></pre>
<p>This is quite useful for portability, since to use the same pipeline across institution/computing clusters one only needs to change the flow definition and R function remains intact.</p>
<p>Refer to help section on <a href="http://flow-r.github.io/flowr/rd.html#run">run</a> for more details.</p>
<div class="alert alert-info" role="alert">
<p><strong>Tip</strong>: Its important to note, that in this example we are using R functions, but any other language can be used to create a tab-delimited flowmat file, and submitted using <code>submit_flow</code> command.</p>
</div>
</div>
<div id="nomenclature-for-parameters" class="section level2">
<h2 class="hasAnchor">
<a href="#nomenclature-for-parameters" class="anchor"></a>Nomenclature for parameters</h2>
<p>Here is a good example: <a href="https://github.com/flow-r/flowr/blob/master/inst/pipelines/fastq_bam_bwa.conf" class="uri">https://github.com/flow-r/flowr/blob/master/inst/pipelines/fastq_bam_bwa.conf</a></p>
<blockquote>
<p>(recommended for increased compatibility)</p>
</blockquote>
<ol style="list-style-type: decimal">
<li>all binaries end with <strong>_exe</strong>
</li>
<li>all folders end with <strong>_dir</strong>
</li>
<li>all jar files end with <strong>_jar</strong>
</li>
<li>specify cpu’s using <code>&lt;%CPU%&gt;</code>, this makes this value dynamic and is picked up by the flow definition</li>
</ol>
<!--## Flow of data

Idea is that,
1. output of a **modA** can be fetched via **modA$outfiles**
2. it will be piped into say a second module B
--><!-- The first argument to run is the name of the pipeline, 
one may use a custom flow definition etc. Further any extra arguments supplied are passed on to the pipeline function.
For example, the `sleep_pipe` function has a argument **x** which 
determines number of tmp files to create. Default is 3, let us try changing that. --><!-- We then define another function `sleep_pipe` which calls the above defined **modules**; fetches flowmat from each, 
creating a larger flowmat. This time we will define a flowdef for the `sleep_pipe` function, elevating its status from
module to a pipeline.
This time we will define a flowdef for the `sleep_pipe` function, elevating its status from
module to a pipeline.
Here are a few examples of modules, three functions `sleep`, `create_tmp` and `merge_size` each returning a flowmat.
We believe pipeline and modules may be interchangeble, in the sense that a *smaller* pipeline may be 
included as part of a larger pipeline.
In flowr a module OR pipeline always returns a flowmat.
The only difference being, a pipeline also has a correspomding flow definition file. 
<div class="alert alert-info" role="alert">
As such, creating a flow definition for a module enables flowr
to run it, hence a module **elevates**, becoming a pipeline.
This lets the user mix and match several modules/pipelines to create a customized larger pipeline(s).
</div> --><script src="files/googl.js"></script>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sahil Seth.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
