<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>flowr • flowr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="flowr">
<meta property="og:description" content="flowr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">flowr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.9.11</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/flowr_install.html">flowr</a>
    </li>
    <li>
      <a href="../articles/flowr_overview.html">flowr</a>
    </li>
    <li>
      <a href="../articles/flowr_tutorial.html">flowr</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/flow-r/flowr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="flowr_overview_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>flowr</h1>
            <h3 class="subtitle">Streamlining Workflows</h3>
                        <h4 class="author">Sahil Seth</h4>
            
            <h4 class="date">2021-03-01</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/flow-r/flowr/blob/master/vignettes/flowr_overview.Rmd"><code>vignettes/flowr_overview.Rmd</code></a></small>
      <div class="hidden name"><code>flowr_overview.Rmd</code></div>

    </div>

    
    
<div id="get-started" class="section level1">
<h1 class="hasAnchor">
<a href="#get-started" class="anchor"></a>Get started</h1>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/flow-r/flowr">flowr</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>This will copy the flowr helper script to <code>~/bin</code>. Please make sure that this folder is in your <code>$PATH</code> variable. For more details refer to <a href="http://flow-r.github.io/flowr/rd.html#setup">setup’s help section</a>.</p>
<p>Running flowr from the terminal will fetch you the following:</p>
<pre><code>Usage: flowr function [arguments]

status          Detailed status of a flow(s).
rerun           rerun a previously failed flow
kill            Kill the flow, upon providing working directory
fetch_pipes     Checking what modules and pipelines are available; flowr fetch_pipes

Please use 'flowr -h function' to obtain further information about the usage of a specific function.</code></pre>
<div id="toy-example" class="section level2">
<h2 class="hasAnchor">
<a href="#toy-example" class="anchor"></a>Toy example</h2>
<p><img src="files/toy.png"></p>
<p>Consider, a simple example where we have <strong>three</strong> instances of linux’s <code>sleep</code> command. After its completion <strong>three</strong> tmp files are created with some random data. Then, a merging step follows, combining the tmp files into one big file. Next, we use <code>du</code> to calculate the size of the merged file.</p>
<div class="alert alert-info" role="alert">
<p><strong>NGS context</strong> This is quite similar in structure to a typical workflow from where a series of alignment and sorting steps may take place on the raw fastq files. Followed by merging of the resulting bam files into one large file per-sample and further downstream processing.</p>
</div>
<p>To create this flow in flowr, we need the actual commands to run; and a set of instructions regarding how to stitch the individual steps into a coherent pipeline.</p>
<p>Here is a table with the commands we would like to run ( or <code>flow mat</code> ).</p>
<table class="table">
<colgroup>
<col width="12%">
<col width="12%">
<col width="74%">
</colgroup>
<thead><tr class="header">
<th align="left">samplename</th>
<th align="left">jobname</th>
<th align="left">cmd</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample1</td>
<td align="left">sleep</td>
<td align="left">sleep 10 &amp;&amp; sleep 2;echo ‘hello’</td>
</tr>
<tr class="even">
<td align="left">sample1</td>
<td align="left">sleep</td>
<td align="left">sleep 11 &amp;&amp; sleep 8;echo ‘hello’</td>
</tr>
<tr class="odd">
<td align="left">sample1</td>
<td align="left">sleep</td>
<td align="left">sleep 11 &amp;&amp; sleep 17;echo ‘hello’</td>
</tr>
<tr class="even">
<td align="left">sample1</td>
<td align="left">create_tmp</td>
<td align="left">head -c 100000 /dev/urandom &gt; sample1_tmp_1</td>
</tr>
<tr class="odd">
<td align="left">sample1</td>
<td align="left">create_tmp</td>
<td align="left">head -c 100000 /dev/urandom &gt; sample1_tmp_2</td>
</tr>
<tr class="even">
<td align="left">sample1</td>
<td align="left">create_tmp</td>
<td align="left">head -c 100000 /dev/urandom &gt; sample1_tmp_3</td>
</tr>
<tr class="odd">
<td align="left">sample1</td>
<td align="left">merge</td>
<td align="left">cat sample1_tmp_1 sample1_tmp_2 sample1_tmp_3 &gt; sample1_merged</td>
</tr>
<tr class="even">
<td align="left">sample1</td>
<td align="left">size</td>
<td align="left">du -sh sample1_merged; echo ‘MY shell:’ $SHELL</td>
</tr>
</tbody>
</table>
<p>Further, we use an additional file specifying the relationship between the steps, and also other resource requirements: <a href="/docs.html#flow-definition">flow_def</a>.</p>
<table class="table">
<colgroup>
<col width="11%">
<col width="9%">
<col width="11%">
<col width="9%">
<col width="6%">
<col width="16%">
<col width="9%">
<col width="13%">
<col width="9%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="left">jobname</th>
<th align="left">sub_type</th>
<th align="left">prev_jobs</th>
<th align="left">dep_type</th>
<th align="left">queue</th>
<th align="left">memory_reserved</th>
<th align="left">walltime</th>
<th align="right">cpu_reserved</th>
<th align="left">platform</th>
<th align="right">jobid</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sleep</td>
<td align="left">scatter</td>
<td align="left">none</td>
<td align="left">none</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">local</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">create_tmp</td>
<td align="left">scatter</td>
<td align="left">sleep</td>
<td align="left">serial</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">local</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">merge</td>
<td align="left">serial</td>
<td align="left">create_tmp</td>
<td align="left">gather</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">local</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">size</td>
<td align="left">serial</td>
<td align="left">merge</td>
<td align="left">serial</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">local</td>
<td align="right">4</td>
</tr>
</tbody>
</table>
<div class="alert alert-info" role="alert">
<p><strong>Note:</strong> Each row in a flow mat relates to one job. Jobname column is used to link flow definition with flow mat. Also, values in previous jobs (prev_jobs) are derived from jobnames.</p>
</div>
</div>
<div id="stitch-it" class="section level2">
<h2 class="hasAnchor">
<a href="#stitch-it" class="anchor"></a>Stitch it</h2>
<p>We use the two files described above and stitch them to create a <code>flow object</code> (which contains all the information we need for cluster submission).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ex</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"flowr"</span><span class="op">)</span>, <span class="st">"pipelines"</span><span class="op">)</span>
<span class="va">flowmat</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowmat.html">as.flowmat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">ex</span>, <span class="st">"sleep_pipe.tsv"</span><span class="op">)</span><span class="op">)</span>
<span class="va">flowdef</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowdef.html">as.flowdef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">ex</span>, <span class="st">"sleep_pipe.def"</span><span class="op">)</span><span class="op">)</span>

<span class="va">fobj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/to_flow.html">to_flow</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">flowmat</span>, 
                 def <span class="op">=</span> <span class="va">flowdef</span>,
                 flowname <span class="op">=</span> <span class="st">"example1"</span>, <span class="co">## give it a name</span>
                 platform <span class="op">=</span> <span class="st">"lsf"</span><span class="op">)</span>      <span class="co">## override platform mentioned in flow def</span></code></pre></div>
<p>Refer to <a href="http://flow-r.github.io/flowr/rd.html#to_flow">to_flow’s help section</a> for more details.</p>
</div>
<div id="plot-it" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-it" class="anchor"></a>Plot it</h2>
<p>We can use <a href="http://flow-r.github.io/flowr/rd.html#plot_flow">plot_flow</a> to quickly visualize the flow; this really helps when developing complex workflows.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_flow.html">plot_flow</a></span><span class="op">(</span><span class="va">fobj</span><span class="op">)</span>     <span class="co"># ?plot_flow for more information</span>
<span class="fu"><a href="../reference/plot_flow.html">plot_flow</a></span><span class="op">(</span><span class="va">flowdef</span><span class="op">)</span> <span class="co"># plot_flow works on flow definition as well</span></code></pre></div>
<div class="figure">
<img src="flowr_overview_files/figure-html/plotit-1.png" alt="Flow chart describing process for example 1" width="700"><p class="caption">
Flow chart describing process for example 1
</p>
</div>
<p>Refer to <a href="http://flow-r.github.io/flowr/rd.html#plot_flow">plot_flow’s help section</a> for more details.</p>
</div>
<div id="dry-run" class="section level2">
<h2 class="hasAnchor">
<a href="#dry-run" class="anchor"></a>Dry Run</h2>
<div class="alert alert-info" role="alert">
<p><b>Dry run</b>: Quickly perform a dry run, of the submission step. This creates all the folder and files, and skips submission to the cluster. This helps in debugging etc.</p>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/submit_flow.html">submit_flow</a></span><span class="op">(</span><span class="va">fobj</span><span class="op">)</span></code></pre></div>
<pre><code>Test Successful!
You may check this folder for consistency. Also you may re-run submit with execute=TRUE
 ~/flowr/sleep_pipe-20150520-15-18-27-5mSd32G0</code></pre>
</div>
<div id="submit-it" class="section level2">
<h2 class="hasAnchor">
<a href="#submit-it" class="anchor"></a>Submit it</h2>
<p>Once, we have a flow we can submit it to the cluster using <a href="http://flow-r.github.io/flowr/rd.html#submit_flow">submit_flow</a></p>
<div class="alert alert-info" role="alert">
<p>Submit to the cluster !</p>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/submit_flow.html">submit_flow</a></span><span class="op">(</span><span class="va">fobj</span>, execute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>Flow has been submitted. Track it from terminal using:
flowr status x=~/flowr/type1-20150520-15-18-46-sySOzZnE</code></pre>
<p>Refer to <a href="http://flow-r.github.io/flowr/rd.html#submit_flow">submit_flow’s help section</a> for more details.</p>
</div>
<div id="check-its-status" class="section level2">
<h2 class="hasAnchor">
<a href="#check-its-status" class="anchor"></a>Check its status</h2>
<p>Next, you may use <a href="http://flow-r.github.io/flowr/rd.html#status">status</a> to monitor the status of a flow.</p>
<pre><code>flowr status x=~/flowr/runs/sleep_pipe-20150520*

|          | total| started| completed| exit_status|    status|
|:---------|-----:|-------:|---------:|-----------:|---------:|
|001.sleep |    10|      10|        10|           0| completed|
|002.tmp   |    10|      10|        10|           0| completed|
|003.merge |     1|       1|         1|           0| completed|
|004.size  |     1|       1|         1|           0| completed|</code></pre>
<p>Notice, how we skipped specifying the complete path. Status would try to use the basename and show status of any folder it can match. If there are multiple matched, status would show a summary of each.</p>
<p>Alternatively, to check a summarized status of several flows, use the parent folder. In this case the parent folder has 3 flows, and here is the summary:</p>
<pre><code>flowr status x=~/flowr/runs

Showing status of: ~/flowr/runs
|          | total| started| completed| exit_status|    status|
|:---------|-----:|-------:|---------:|-----------:|---------:|
|001.sleep |    30|      30|        10|           0|processing|
|002.tmp   |    30|      30|        10|           0|processing|
|003.merge |     3|       3|         1|           0|   pending|
|004.size  |     3|       3|         1|           0|   pending|</code></pre>
<div class="alert alert-success" role="alert">
<p><b>Scalability</b>: Quickly submit, and check a summarized OR detailed status on ten or hundreds of flows.</p>
</div>
<p>Refer to <a href="http://flow-r.github.io/flowr/rd.html#status">status’s help section</a> for more details.</p>
</div>
<div id="kill-it" class="section level2">
<h2 class="hasAnchor">
<a href="#kill-it" class="anchor"></a>Kill it</h2>
<p>Incase something goes wrong, one may use to kill command to terminate all the relating jobs of a single flow OR multiple flows.</p>
<p>kill one flow:</p>
<pre><code>flowr kill_flow x=flow_wd</code></pre>
<div class="alert alert-warning" role="alert">
<p>One may instruct flowr to kill multiple flows, but flowr would confirm before killing.</p>
</div>
<pre><code>flowr kill x='~/flowr/runs/sleep_pipe'
found multiple wds:
  ~/flowr/runs/sleep_pipe-20150825-16-24-04-0Lv1PbpI
  ~/flowr/runs/sleep_pipe-20150825-17-47-52-5vFIkrMD
Really kill all of them ? kill again with force=TRUE</code></pre>
<p>To kill multiple flow, set force=TRUE:</p>
<pre><code>kill x='~/flowr/runs/sleep_pipe*' force = TRUE</code></pre>
<p>Refer to <a href="http://flow-r.github.io/flowr/rd.html#kill">kill’s help section</a> for more details.</p>
</div>
<div id="re-run-a-flow" class="section level2">
<h2 class="hasAnchor">
<a href="#re-run-a-flow" class="anchor"></a>Re-run a flow</h2>
<p>flowr also enables you to re-run a pipeline in case of hardware or software failures.</p>
<ul>
<li>
<strong>hardware failure</strong>: no change to the pipeline is required, simply rerun it: <code>rerun x=flow_wd  start_from=&lt;intermediate step&gt;</code>
</li>
<li>
<strong>software failure</strong>: either a change to flowmat or flowdef has been made: <code>rerun x=flow_wdmat = new_flowmat def = new_flowdef start_from=&lt;intermediate step&gt;</code>
</li>
</ul>
<p>Refer to <a href="http://flow-r.github.io/flowr/rd.html#rerun">rerun’s help section</a> for more details.</p>
</div>
</div>
<div id="input-files" class="section level1">
<h1 class="hasAnchor">
<a href="#input-files" class="anchor"></a>Input files</h1>
<p>An easy and quick way to build a workflow is to create a set of two tab delimited files. First is a table with commands to run (for each step of the pipeline), while second has details regarding how the modules are stitched together. In the rest of this document we would refer to them as <code>flow_mat</code> and <code>flow_def</code> respectively (as introduced in the previous sections).</p>
<p>Let us read in examples of both these files to understand their structure.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ex</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span>package <span class="op">=</span> <span class="st">"flowr"</span><span class="op">)</span>, <span class="st">"pipelines"</span><span class="op">)</span>
<span class="va">flow_mat</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowmat.html">as.flowmat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">ex</span>, <span class="st">"sleep_pipe.tsv"</span><span class="op">)</span><span class="op">)</span>
<span class="va">flow_def</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowdef.html">as.flowdef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">ex</span>, <span class="st">"sleep_pipe.def"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div id="flow-matrix" class="section level2">
<h2 class="hasAnchor">
<a href="#flow-matrix" class="anchor"></a>1. Flow matrix</h2>
<div class="alert alert-info" role="alert">
<p>describes commands to run:</p>
<p>Each row in flow mat describes one shell command, with additional information regarding the name of the step etc.</p>
</div>
<p>Essentially, this is a tab delimited file with three columns:</p>
<ul>
<li>
<code>samplename</code>: A grouping column. The table is split using this column and each subset is treated as an individual flow. Thus we may have one flowmat for a series of samples, and the whole set would be submitted as a batch.
<ul>
<li>If all the commands are for a single sample, one can just repeat a dummy name like sample1 all throughout.</li>
</ul>
</li>
<li>
<code>jobname</code>: This corresponds to the name of the step. This should match exactly with the jobname column in flow_def table described below.</li>
<li>
<code>cmd</code>: A shell command to run. One can get quite creative here. These could be multiple shell commands separated by a <code>;</code> or <code><a href="https://rdrr.io/r/base/Logic.html">&amp;&amp;</a></code>, more on this <a href="http://stackoverflow.com/questions/3573742/difference-between-echo-hello-ls-vs-echo-hello-ls">here</a>. Though to keep this clean you may just wrap a multi-line command into a script and just source the bash script from here.</li>
</ul>
<p>Here is an example <a href="https://github.com/flow-r/flowr/blob/master/inst/pipelines/sleep_pipe.tsv">flow_mat</a> for the flowr described above.</p>
<table class="table">
<colgroup>
<col width="12%">
<col width="12%">
<col width="74%">
</colgroup>
<thead><tr class="header">
<th align="left">samplename</th>
<th align="left">jobname</th>
<th align="left">cmd</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sample1</td>
<td align="left">sleep</td>
<td align="left">sleep 10 &amp;&amp; sleep 2;echo ‘hello’</td>
</tr>
<tr class="even">
<td align="left">sample1</td>
<td align="left">sleep</td>
<td align="left">sleep 11 &amp;&amp; sleep 8;echo ‘hello’</td>
</tr>
<tr class="odd">
<td align="left">sample1</td>
<td align="left">sleep</td>
<td align="left">sleep 11 &amp;&amp; sleep 17;echo ‘hello’</td>
</tr>
<tr class="even">
<td align="left">sample1</td>
<td align="left">create_tmp</td>
<td align="left">head -c 100000 /dev/urandom &gt; sample1_tmp_1</td>
</tr>
<tr class="odd">
<td align="left">sample1</td>
<td align="left">create_tmp</td>
<td align="left">head -c 100000 /dev/urandom &gt; sample1_tmp_2</td>
</tr>
<tr class="even">
<td align="left">sample1</td>
<td align="left">create_tmp</td>
<td align="left">head -c 100000 /dev/urandom &gt; sample1_tmp_3</td>
</tr>
<tr class="odd">
<td align="left">sample1</td>
<td align="left">merge</td>
<td align="left">cat sample1_tmp_1 sample1_tmp_2 sample1_tmp_3 &gt; sample1_merged</td>
</tr>
<tr class="even">
<td align="left">sample1</td>
<td align="left">size</td>
<td align="left">du -sh sample1_merged; echo ‘MY shell:’ $SHELL</td>
</tr>
</tbody>
</table>
</div>
<div id="flow-definition" class="section level2">
<h2 class="hasAnchor">
<a href="#flow-definition" class="anchor"></a>2. Flow definition</h2>
<div class="alert alert-info" role="alert">
<p>defines how to stitch pieces of the (work)flow:</p>
<p>Each row in this table refers to one step of the pipeline. It describes the resources used by the step and also its relationship with other steps, especially, the step immediately prior to it.</p>
</div>
<p>It is a tab separated file, with a minimum of 4 columns:</p>
<ul>
<li>
<code>jobname</code>: Name of the step</li>
<li>
<code>sub_type</code>: Short for <a href="#submission-types">submission type</a>, refers to, how should multiple commands of this step be submitted. Possible values are <code>serial</code> or <code>scatter</code>.</li>
<li>
<code>prev_job</code>: Short for previous job, this would be jobname of the previous job. This can be NA/./none if this is a independent/initial step, and no previous step is required for this to start.</li>
<li>
<code>dep_type</code>: Short for <a href="#dependency-types">dependency type</a>, refers to the relationship of this job with the one defined in <code>prev_job</code>. This can take values <code>none</code>, <code>gather</code>, <code>serial</code> or <code>burst</code>.</li>
</ul>
<p>These would be explained in detail, below.</p>
<p>Apart from the above described variables, several others defining the resource requirements of each step are also available. These give great amount of flexibility to the user in choosing CPU, wall time, memory and queue for each step (and are passed along to the HPCC platform).</p>
<ul>
<li><code>cpu_reserved</code></li>
<li><code>memory_reserved</code></li>
<li><code>nodes</code></li>
<li><code>walltime</code></li>
<li><code>queue</code></li>
</ul>
<div class="alert alert-info" role="alert">
<p>This is especially useful for genomics pipelines, since each step may use different amount of resources. For example, in other frameworks, if one step uses 16 cores these would be blocked and not used during processing of several other steps. Thus resulting in blockage of those cores. Flowr prevents this, by being able to tune resources granurly. Example, one may submit few short steps in <code>short</code> queue, and longer steps of the same pipeline in say <code>long</code> queue.</p>
</div>
<p>Most cluster platforms accept these resource arguments. Essentially a file like <a href="https://github.com/flow-r/flowr/blob/master/inst/conf/torque.sh">this</a> is used as a template, and variables defined in curly braces ( ex. <code>{{{CPU}}}</code> ) are filled up using the flow definition file.</p>
<div class="alert alert-warning" role="alert">
<p>If these (resource requirements) columns are not included in the flow definition, their values should be explicitly defined in the <a href="https://github.com/flow-r/flowr/blob/master/inst/conf">submission template</a>. One may customize the templates as described in the <a href="#cluster-support">cluster support</a> section.</p>
</div>
<p>Here is an example of a typical <a href="https://raw.githubusercontent.com/sahilseth/flowr/master/inst/pipelines/sleep_pipe.def">flow_def</a> file.</p>
<table class="table">
<colgroup>
<col width="11%">
<col width="9%">
<col width="11%">
<col width="9%">
<col width="6%">
<col width="16%">
<col width="9%">
<col width="13%">
<col width="9%">
<col width="6%">
</colgroup>
<thead><tr class="header">
<th align="left">jobname</th>
<th align="left">sub_type</th>
<th align="left">prev_jobs</th>
<th align="left">dep_type</th>
<th align="left">queue</th>
<th align="left">memory_reserved</th>
<th align="left">walltime</th>
<th align="right">cpu_reserved</th>
<th align="left">platform</th>
<th align="right">jobid</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">sleep</td>
<td align="left">scatter</td>
<td align="left">none</td>
<td align="left">none</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">local</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">create_tmp</td>
<td align="left">scatter</td>
<td align="left">sleep</td>
<td align="left">serial</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">local</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">merge</td>
<td align="left">serial</td>
<td align="left">create_tmp</td>
<td align="left">gather</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">local</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">size</td>
<td align="left">serial</td>
<td align="left">merge</td>
<td align="left">serial</td>
<td align="left">short</td>
<td align="left">2000</td>
<td align="left">1:00</td>
<td align="right">1</td>
<td align="left">local</td>
<td align="right">4</td>
</tr>
</tbody>
</table>
<div id="example" class="section level3">
<h3 class="hasAnchor">
<a href="#example" class="anchor"></a>Example:</h3>
<p>Let us use an example flow, to understand submission and dependency types.</p>
<p>Consider three steps A, B and C, where A has 10 commands from A1 to A10, similarly B has 10 commands B1 through B10 and C has a single command, C1. Consider another step D (with D1-D3), which comes after C.</p>
<pre><code>step:       A   ----&gt; B  -----&gt; C -----&gt; D
# of cmds  10        10         1        3</code></pre>
</div>
</div>
</div>
<div id="submission-types" class="section level1">
<h1 class="hasAnchor">
<a href="#submission-types" class="anchor"></a>Submission types</h1>
<p><em>This refers to the sub_type column in flow definition.</em></p>
<ul>
<li>
<code>scatter</code>: submit all commands as parallel, independent jobs.
<ul>
<li><em>Submit A1 through A10 as independent jobs</em></li>
</ul>
</li>
<li>
<code>serial</code>: run these commands sequentially one after the other.
<ul>
<li><em>Wrap A1 through A10, into a single job.</em></li>
</ul>
</li>
</ul>
</div>
<div id="dependency-types" class="section level1">
<h1 class="hasAnchor">
<a href="#dependency-types" class="anchor"></a>Dependency types</h1>
<p><em>This refers to the dep_type column in flow definition.</em></p>
<ul>
<li>
<code>none</code>: independent job.
<ul>
<li><em>Initial step A has no dependency</em></li>
</ul>
</li>
<li>
<code>serial</code>: <em>one to one</em> relationship with previous job.
<ul>
<li><em>B1 can start as soon as A1 completes.</em></li>
</ul>
</li>
<li>
<code>gather</code>: <em>many to one</em>, wait for <strong>all</strong> commands in previous job to finish then start the current step.
<ul>
<li><em>All jobs of B (1-10), need to complete before C1 is started</em></li>
</ul>
</li>
<li>
<code>burst</code>: <em>one to many</em> wait for the previous step which has one job and start processing all cmds in the current step.
<ul>
<li><em>D1 to D3 are started as soon as C1 finishes.</em></li>
</ul>
</li>
</ul>
</div>
<div id="relationships" class="section level1">
<h1 class="hasAnchor">
<a href="#relationships" class="anchor"></a>Relationships</h1>
<p>Using the above submission and dependency types one can create several types of relationships between former and later jobs. Here are a few examples of relationships one may typically use.</p>
<div id="one-to-one-serial" class="section level2">
<h2 class="hasAnchor">
<a href="#one-to-one-serial" class="anchor"></a>One to One (serial)</h2>
<pre><code>                A1 --------&gt; B1
                A2 --------&gt; B1
                .. --------&gt; ..
               A10 --------&gt; B10
 dependency submission  dependency submission   
    none     scatter      serial     scatter
                 relationship
                  ONE-to-ONE</code></pre>
<p>Relationship between steps A and B is best defined as <code>serial</code>. Step A (A1 through A10) is submitted as scatter. Further, <span class="math inline">\(i^th\)</span> jobs of B depends on <span class="math inline">\(i^th\)</span> jobs of A. i.e. B1 requires A1 to complete; B2 requires A2 and so on. Also, we note that defining dependency as serial, makes sure that B does not wait for all elements of A to complete.</p>
<p><img src="flowr_overview_files/figure-html/plot_one_one-1.png" width="700"></p>
</div>
<div id="many-to-one-gather" class="section level2">
<h2 class="hasAnchor">
<a href="#many-to-one-gather" class="anchor"></a>Many to One (gather)</h2>
<pre><code>                B1 ----\ 
                B2 -----\
                ..        -----&gt; C1
                B9 ------/
                B10-----/
 dependency submission  dependency submission   
    serial     scatter    gather     serial
                 relationship
                  MANY-to-ONE</code></pre>
<p>Since C is a single command which requires all steps of B to complete, intuitively it needs to <code>gather</code> pieces of data generated by B. In this case <code>dep_type</code> would be <code>gather</code> and <code>sub_type</code> type would be <code>serial</code> since it is a single command.</p>
</div>
<div id="one-to-many-burst" class="section level2">
<h2 class="hasAnchor">
<a href="#one-to-many-burst" class="anchor"></a>One to Many (Burst)</h2>
<pre><code>                     /-----&gt; D1
                C1 --------&gt; D2
                     \-----&gt; D3
 dependency submission  dependency submission   
    gather   serial       burst     scatter
                 relationship
                  ONE-to-MANY</code></pre>
<p>Further, D is a set of three commands (D1-D3), which need to wait for a single process (C1) to complete. They would be submitted as <code>scatter</code> after waiting on C in a <code>burst</code> type dependency.</p>
<p>In essence, an example flow_def would look like as follows (with additional resource requirements not shown for brevity):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ex2def</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowdef.html">as.flowdef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">ex</span>, <span class="st">"abcd.def"</span><span class="op">)</span><span class="op">)</span>
<span class="va">ex2mat</span> <span class="op">=</span> <span class="fu"><a href="../reference/to_flowmat.html">as.flowmat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">ex</span>, <span class="st">"abcd.tsv"</span><span class="op">)</span><span class="op">)</span>
<span class="fu">kable</span><span class="op">(</span><span class="va">ex2def</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">jobname</th>
<th align="left">sub_type</th>
<th align="left">prev_jobs</th>
<th align="left">dep_type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">A</td>
<td align="left">scatter</td>
<td align="left">none</td>
<td align="left">none</td>
</tr>
<tr class="even">
<td align="left">B</td>
<td align="left">scatter</td>
<td align="left">A</td>
<td align="left">serial</td>
</tr>
<tr class="odd">
<td align="left">C</td>
<td align="left">serial</td>
<td align="left">B</td>
<td align="left">gather</td>
</tr>
<tr class="even">
<td align="left">D</td>
<td align="left">scatter</td>
<td align="left">C</td>
<td align="left">burst</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plot_flow.html">plot_flow</a></span><span class="op">(</span><span class="va">ex2def</span><span class="op">)</span></code></pre></div>
<p><img src="flowr_overview_files/figure-html/plot_abcd-1.png" width="700"></p>
<div class="alert alert-info" role="alert">
<p>There is a darker more prominent shadow to indicate scatter steps.</p>
</div>
</div>
</div>
<div id="cluster-support" class="section level1">
<h1 class="hasAnchor">
<a href="#cluster-support" class="anchor"></a>Cluster Support</h1>
<p>As of now we have tested this on the following clusters:</p>
<table class="table">
<thead><tr class="header">
<th align="left">Platform</th>
<th align="left">command</th>
<th align="left">status</th>
<th align="left">queue.type</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">LSF 7</td>
<td align="left">bsub</td>
<td align="left">Beta</td>
<td align="left">lsf</td>
</tr>
<tr class="even">
<td align="left">LSF 9.1</td>
<td align="left">bsub</td>
<td align="left">Stable</td>
<td align="left">lsf</td>
</tr>
<tr class="odd">
<td align="left">Torque</td>
<td align="left">qsub</td>
<td align="left">Stable</td>
<td align="left">torque</td>
</tr>
<tr class="even">
<td align="left">Moab</td>
<td align="left">msub</td>
<td align="left">Stable</td>
<td align="left">moab</td>
</tr>
<tr class="odd">
<td align="left">SGE</td>
<td align="left">qsub</td>
<td align="left">Beta</td>
<td align="left">sge</td>
</tr>
<tr class="even">
<td align="left">SLURM</td>
<td align="left">sbatch</td>
<td align="left">alpha</td>
<td align="left">slurm</td>
</tr>
</tbody>
</table>
<p>For more details, refer to the <a href="http://flow-r.github.io/flowr/install.html#cluster">configuration section</a></p>
<script src="files/googl.js"></script>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sahil Seth.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
